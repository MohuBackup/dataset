{
    "type": "article",
    "id": 140,
    "tags": [
        {
            "tag-id": 708,
            "tag-name": "IPv6"
        },
        {
            "tag-id": 209,
            "tag-name": "科技"
        },
        {
            "tag-id": 426,
            "tag-name": "网络"
        }
    ],
    "relatedQuestions": [
        {
            "title": "ipv6的墙会更高还是更低",
            "id": 3177
        }
    ],
    "detail": {
        "title": "论 NAT6（IPv6 NAT）",
        "body": "<p><a href=\"/article/138\" target=\"_self\" title=\"\">《ER-X 折腾计划》</a>便讲过。</p><p>实际上这次的教程可以适配任何 OpenWrt 支持的设备，不仅限于 ER-X。</p><p>要进行 IPv6 NAT，就必须安装上 kmod-ipt-nat6，而这个包 OpenWrt 不自带，所以：</p><pre>opkg&nbsp;update<br>\nopkg&nbsp;install&nbsp;kmod-ipt-nat6</pre><p>或者在 LuCI 拉取软件源，然后查找 kmod-ipt-nat6 安装：</p><p><img src=\"/uploads/ueditor/20180629/1530256590730811.png\" title=\"1530256590730811.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f31332f66393261323231323464306563626235353663326461623462343836316164393062336166632e706e67.png\"></p><p>非常地简单（大嘘）</p><p>然后我们要注意，如果 LAN 的地址段属于 ULA，那么 OpenWrt 便不会公布网关，所以需要勾选：</p><p><img src=\"/uploads/ueditor/20180629/1530256617675163.png\" title=\"1530256617675163.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f66302f30666563306466623062623164366337616132656361336538613233616535363232666362382e706e67.png\"></p><p>那么如何开启 NAT6 呢？在防火墙的自定义规则加如下：</p><p><img src=\"/uploads/ueditor/20180629/1530256638424746.png\" title=\"1530256638424746.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f66372f33656434363663626334366539316464346234366430626265363738336463393730656637312e706e67.png\"></p><pre>#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（Linux）<br>\niface_linux=pppoe-wan<br>\n#&nbsp;建立&nbsp;IPv6&nbsp;NAT<br>\nip6tables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;POSTROUTING&nbsp;-o&nbsp;$iface_linux&nbsp;-j&nbsp;MASQUERADE</pre><p>其中 iface_linux 便是：</p><p><img src=\"/uploads/ueditor/20180629/1530256731323526.png\" title=\"1530256731323526.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f38352f32346134313866366262396232323165343365363638366664613562363433616332643032352e706e67.png\"></p><p>こ↑こ↓。按下「重启防火墙」保存。</p><p>但是一般我们拨号拨出来的网关是 fe80 开头的网关，所以可以在 /etc/hotplug.d/iface 建立个脚本，来自动添加路由表。</p><p>先在 /etc/hotplug.d/iface 建立 99-ipv6。当然 hotplug 的脚本其实不必 chmod +x。</p><p>脚本内容如下：</p><pre>#!/bin/sh<br>\n[&nbsp;\"$ACTION\"&nbsp;=&nbsp;ifup&nbsp;]&nbsp;||&nbsp;exit&nbsp;0<br>\n#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（UCI）<br>\niface_uci=wan_6<br>\n#&nbsp;定义&nbsp;IPv6&nbsp;WAN&nbsp;接口名（Linux）<br>\niface_linux=pppoe-wan<br>\n[&nbsp;-z&nbsp;\"$iface_uci\"&nbsp;-o&nbsp;\"$INTERFACE\"&nbsp;=&nbsp;\"$iface_uci\"&nbsp;]&nbsp;||&nbsp;exit&nbsp;0<br>\nip&nbsp;-6&nbsp;route&nbsp;add&nbsp;`ip&nbsp;-6&nbsp;route&nbsp;|&nbsp;grep&nbsp;$iface_linux&nbsp;|&nbsp;grep&nbsp;via&nbsp;|&nbsp;sed&nbsp;-e&nbsp;'s/from&nbsp;[^&nbsp;]*&nbsp;//'&nbsp;|&nbsp;sed&nbsp;-e&nbsp;'2,$d'`<br>\nlogger&nbsp;-t&nbsp;IPv6&nbsp;\"Add&nbsp;IPv6&nbsp;default&nbsp;route.\"</pre><p>iface_linux 已经讲过了，但是 iface_uci 又没讲过。其实：</p><p><img src=\"/uploads/ueditor/20180629/1530256844336948.png\" title=\"1530256844336948.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f61312f66393663383961376536306236363063393539383763646132303663616163383766363662612e706e67.png\"></p><p>但是泽个东西 LuCI 在显示的时候全部转成了大写，就会踩到大小写民感的雷。</p><p><img src=\"/uploads/ueditor/20180629/1530256860734762.png\" title=\"1530256860734762.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f37656636306663323137396539333739373665656263666562336261353639653261303162342e706e67.png\"></p><p>然后看看地址栏。</p><p><img src=\"/uploads/ueditor/20180629/1530256875985273.png\" title=\"1530256875985273.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f64382f35636261376531323939623039323731663262623137316561616430373139363966316431302e706e67.png\"></p><p>嗯，所以是小写的「wan」。那么上面的脚本为什么写「wan_6」？</p><p>因为 OpenWrt 对 PPPoE 会虚拟出一个 IPv6 接口，其 UCI 名是原本的名称后面接上「_6」。如果是 DHCPv6 客户端模式就不用加。</p><p>然后重启路由器，不出意外的话 NAT6 就成功了：</p><p><img src=\"/uploads/ueditor/20180629/1530256994847631.png\" title=\"1530256994847631.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f34362f38336530663236393332306638666232353966393261653831626563383732323438393134642e706e67.png\"></p><p><img src=\"/uploads/ueditor/20180629/1530257009213357.png\" title=\"1530257009213357.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f36302f31326664366236306266303936393164323433613135636566646631356238303436303632392e706e67.png\"></p><p><img src=\"/uploads/ueditor/20180629/1530257012587756.png\" title=\"1530257012587756.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f37332f39656137613539643635303765313261343332653530343764363536316466646330636331302e706e67.png\"></p><p><img src=\"/uploads/ueditor/20180629/1530257022485289.png\" title=\"1530257022485289.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32332f30363038353361633435636666343130316161336335333261343261666266333038366665322e706e67.png\"></p><p>（由此还能看出电信的 IPv6 还跑到了 CERNET（教育网）……其实三大运营商的 IPv6 差不多都是）</p><p>最后看完这篇的大佬们，谢谢茄子，，，</p><h3>（2018 年 7 月 4 日）</h3><p>首先要补充的是，如果地址是 ULA 的话，那么像 Android 等系统可能会优先解析 IPv4。为了避免这种情况，只好不使用 ULA 了。</p><p>但是这个地址也不能乱设，不然冲突了就不好了。所以我们从 <a href=\"/uploads/ueditor/20180704/1530712645950495.png\" title=\"1530712645950495.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32302f38313764303433363263303662646366663466393064306638633566333466353062356535612e706e67.png\"></a></p><p><a href=\"/uploads/ueditor/20180704/1530712645950495.png\" title=\"1530712645950495.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32302f38313764303433363263303662646366663466393064306638633566333466353062356535612e706e67.png\">这个有 Note 的区块我们也不方便用，因为应该是有了用途的。那么我们可以瞄一个无 Note 的区块。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712645950495.png\" title=\"1530712645950495.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32302f38313764303433363263303662646366663466393064306638633566333466353062356535612e706e67.png\"><img src=\"/uploads/ueditor/20180704/1530712662687105.png\" title=\"1530712662687105.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32622f65616137323966366563336364386461626439623539303966366634393830396361303235642e706e67.png\"></a></p><p><a href=\"/uploads/ueditor/20180704/1530712645950495.png\" title=\"1530712645950495.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32302f38313764303433363263303662646366663466393064306638633566333466353062356535612e706e67.png\">这块可以有！</a></p><p><a href=\"/uploads/ueditor/20180704/1530712645950495.png\" title=\"1530712645950495.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32302f38313764303433363263303662646366663466393064306638633566333466353062356535612e706e67.png\">事实上 </a><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\"></a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">（按：d000::/4 显然属于 c000::/3 的一部分）</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">当然，其实我不建议滥用地址，但是迫不得已的情况下不影响到他人（冲突）就没事。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">那么我来谈谈为什么要用 IPv6 NAT。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">事实上，家用 IPv6 的前缀会变化。而且你也保不准会不会拿到 /128 的地址。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">拿到 /128 也只好自认倒楣了。而前缀变化意味着……试想你 IPv6 上得好好的，断线重连原来的地址就失效了（</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">所以我的意思很明白了，，，这种情况下用 Relay 反而不太方便，，，</a></p><h3><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">（2018 年 7 月 31 日）</a></h3><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">今天，OpenWrt 18.06.0 发布！</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">其实单是对比 RC2 和 RC1，LuCI 也有了明显变动。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\"><img src=\"/uploads/ueditor/20180811/1533948472795394.png\" title=\"1533948472795394.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f31322f63353364356233323462663262313732623731393937623964613135393965316666373262652e706e67.png\"></a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">而且 RC2 引入的 LuCI 版本已经明确显示了虚拟的 PPPoE IPv6 接口。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\"><img src=\"/uploads/ueditor/20180811/1533948499394665.png\" title=\"1533948499394665.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f32662f32323938373964326131316533383939356135663738373537313561353262303533396630392e706e67.png\"></a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">注意「协议：虚拟动态接口（DHCPv6 客户端）」这一点。这无疑为我们对虚拟接口的判断提供了便利。</a></p><p><a href=\"/uploads/ueditor/20180704/1530712695228786.png\" title=\"1530712695228786.png\" alt=\"68747470733a2f2f696d672e76696d2d636e2e636f6d2f65632f36643432383834313166393332313362326631383931346263366663653134633866623133622e706e67.png\">目前我先升级了 RC2，至于正式版等待编译完毕再说吧。将在</a><a href=\"/article/138\" target=\"_self\" title=\"\">《ER-X 折腾计划》</a>持续更新。</p><h3>（2018 年 8 月 11 日）</h3><p>除了安装 kmod-ipt-nat6 外，我们还可以选择安装 ip6tables-mod-nat，这样应该就能扩展 DNPT 和 SNPT 了。</p>",
        "author": 6,
        "voters": [],
        "publishTime": "2018-06-29T00:00:00.000Z",
        "modifyTime": "2018-06-29T00:00:00.000Z"
    },
    "comments": [
        {
            "author": {
                "user-id": 1393,
                "user-name": "Chinese淫"
            },
            "body": "搞这个ipv6能给ps4翻墙吗？",
            "publishTime": "2018-06-30T02:15:00.000Z",
            "modifyTime": "2018-06-30T02:15:00.000Z"
        },
        {
            "author": {
                "user-id": 6,
                "user-name": "刘松泉"
            },
            "body": "如果 PS4 支持的话没问题的，主要还得在路由器上搞 Hosts。",
            "publishTime": "2018-06-30T02:47:00.000Z",
            "modifyTime": "2018-06-30T02:47:00.000Z"
        },
        {
            "author": {
                "user-id": 1393,
                "user-name": "Chinese淫"
            },
            "body": "路由器上怎么弄hosts",
            "publishTime": "2018-06-30T03:36:00.000Z",
            "modifyTime": "2018-06-30T03:36:00.000Z"
        },
        {
            "author": {
                "user-id": 6,
                "user-name": "刘松泉"
            },
            "body": "在 DNS 设置指定一个额外的 hosts 文件，然后编辑文件就行了。",
            "publishTime": "2018-06-30T03:49:00.000Z",
            "modifyTime": "2018-06-30T03:49:00.000Z"
        }
    ]
}
